---
layout: post
status: publish
published: true
title: 'SQL Server: the PIVOT operator'
author:
  display_name: admin_rolspace
  login: admin_rolspace
  email: rolandorramos@gmail.com
  url: ''
author_login: admin_rolspace
author_email: rolandorramos@gmail.com
excerpt: "The SQL Server Pivot feature is quite useful in scenarios that require a
  slight manipulation of a&nbsp;table's structure in order to display unique column
  values as column headers.\r\n\r\nSuppose there was a table with the following&nbsp;schema:\r\n<pre
  class=\"line-height:20 top-margin:20 bottom-margin:20 lang:tsql decode:true\">CREATE
  TABLE [Employee](\r\n\t[ID] [int] NOT NULL,\r\n\t[JobTitle] [nvarchar](50) NOT NULL,\r\n\t[Gender]
  [nchar](1) NOT NULL,\r\n\t[BirthDate] [date] NOT NULL,\r\n\t[HireDate] [date] NOT
  NULL)<&#47;pre>\r\n"
wordpress_id: 136
wordpress_url: http://www.rolspace.com/?p=136
date: '2014-09-24 22:32:51 +0200'
date_gmt: '2014-09-24 22:32:51 +0200'
categories:
- Uncategorized
tags:
- sql server
- code
comments: []
---
<p>The SQL Server Pivot feature is quite useful in scenarios that require a slight manipulation of a&nbsp;table's structure in order to display unique column values as column headers.</p>
<p>Suppose there was a table with the following&nbsp;schema:</p>
<pre class="line-height:20 top-margin:20 bottom-margin:20 lang:tsql decode:true">CREATE TABLE [Employee](<br />
	[ID] [int] NOT NULL,<br />
	[JobTitle] [nvarchar](50) NOT NULL,<br />
	[Gender] [nchar](1) NOT NULL,<br />
	[BirthDate] [date] NOT NULL,<br />
	[HireDate] [date] NOT NULL)<&#47;pre><br />
<a id="more"></a><a id="more-136"></a>Here is some sample data for the Employee table:</p>
<div class="table-responsive">
<table class="table table-bordered table-post">
<thead>
<tr>
<th>ID<&#47;th></p>
<th>JobTitle<&#47;th></p>
<th>Gender<&#47;th></p>
<th>BirthDate<&#47;th></p>
<th>HireDate<&#47;th><br />
<&#47;tr><br />
<&#47;thead></p>
<tbody>
<tr>
<td>1<&#47;td></p>
<td>Emperor<&#47;td></p>
<td>Male<&#47;td></p>
<td>1969-01-29<&#47;td></p>
<td>2009-01-14<&#47;td><br />
<&#47;tr></p>
<tr>
<td>2<&#47;td></p>
<td>Sith Lord<&#47;td></p>
<td>Male<&#47;td></p>
<td>1971-08-01<&#47;td></p>
<td>2008-01-31<&#47;td><br />
<&#47;tr></p>
<tr>
<td>3<&#47;td></p>
<td>Death Star Tech<&#47;td></p>
<td>Female<&#47;td></p>
<td>1987-05-23<&#47;td></p>
<td>2010-10-11<&#47;td><br />
<&#47;tr></p>
<tr>
<td>4<&#47;td></p>
<td>Stormtrooper<&#47;td></p>
<td>Male<&#47;td></p>
<td>1966-11-11<&#47;td></p>
<td>2005-07-20<&#47;td><br />
<&#47;tr></p>
<tr>
<td>5<&#47;td></p>
<td>Imperial Guard<&#47;td></p>
<td>Female<&#47;td></p>
<td>1975-06-05<&#47;td></p>
<td>2006-08-03<&#47;td><br />
<&#47;tr></p>
<tr>
<td>6<&#47;td></p>
<td>TIE Bomber Pilot<&#47;td></p>
<td>Female<&#47;td></p>
<td>1977-08-08<&#47;td></p>
<td>2011-04-25<&#47;td><br />
<&#47;tr></p>
<tr>
<td style="text-align: left;" colspan="5">etc, etc...<&#47;td><br />
<&#47;tr><br />
<&#47;tbody><br />
<&#47;table><br />
<&#47;div><br />
Now, let&acute;s say you wanted to obtain a result set that provides the average age of the employees broken down by hire year, using a query like this:</p>
<pre class="line-height:20 top-margin:20 bottom-margin:20 lang:tsql decode:true">SELECT DATEPART(YEAR, HireDate) as HireYear,<br />
       AVG(DATEDIFF(YEAR, BirthDate, GETDATE())) as AverageAge<br />
FROM Employee<br />
   GROUP BY DATEPART(YEAR, HireDate)<&#47;pre><br />
The results:</p>
<table class="table table-bordered table-post" style="width: 75%; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th>HireYear<&#47;th></p>
<th>AverageAge<&#47;th><br />
<&#47;tr><br />
<&#47;thead></p>
<tbody>
<tr>
<td>2010<&#47;td></p>
<td>29<&#47;td><br />
<&#47;tr></p>
<tr>
<td>2011<&#47;td></p>
<td>37<&#47;td><br />
<&#47;tr></p>
<tr>
<td>2012<&#47;td></p>
<td>33<&#47;td><br />
<&#47;tr></p>
<tr>
<td>2013<&#47;td></p>
<td>27<&#47;td><br />
<&#47;tr></p>
<tr>
<td style="text-align: left;" colspan="2">etc, etc...<&#47;td><br />
<&#47;tr><br />
<&#47;tbody><br />
<&#47;table><br />
This is a standard relational result set, but what if we needed to display the data&nbsp;a little differently? What if we needed to display the result set using the <em>HireYear<&#47;em> as the columns of the result set? This is where the Pivot command comes in.</p>
<p>This feature&nbsp;provides a way to modify&nbsp;a&nbsp;result set from a query in a way that allows the unique values from a column to be displayed&nbsp;as the column headers in the pivoted data. In order to start writing a Pivot query, you need a source query expression. For our example, we can use the following query:</p>
<pre class="lang:tsql decode:true">SELECT DATEPART(YEAR, HireDate) as HireYear<br />
       DATEDIFF(YEAR, BirthDate, GETDATE()) as Age,<br />
FROM Employee<&#47;pre><br />
This is a simplified version of the query in the previous section&nbsp;since it is not calculating the average of the age. It will display the <em>HireYear<&#47;em> and <em>Age<&#47;em> for every Employee, so there would be no average calculation at first; that comes in later. This would be the source expression.</p>
<p>Using the&nbsp;source expression, we need to tell the Pivot query the data that we want to use for our rows, as well as the values from the source that we want to use for our columns.</p>
<p>In the example this is easy to spot, for the data rows we want to use the average Employee age based on the year they were hired, so we apply the AVG aggregate function to the <em>Age<&#47;em> values from the source query.</p>
<p>For the column headers, we want to use the unique values from the <em>HireYear<&#47;em> column in the source query. Once this is ready, all that remains is to perform a SELECT on the pivoted data in order to display it.</p>
<pre class="lang:tsql decode:true">SELECT 'AverageAge' AS HireYear,<br />
       PVT.[2010], PVT.[2011],<br />
       PVT.[2012], PVT.[2013]<br />
FROM</p>
<p>&#47;* Source Query *&#47;<br />
(SELECT DATEPART(YEAR, HireDate) as HireYear<br />
        DATEDIFF(YEAR, BirthDate, GETDATE()) as Age,<br />
FROM Employee) AS SOURCE</p>
<p>PIVOT</p>
<p>&#47;* Data rows and pivoted columns *&#47;<br />
(AVG(Age)<br />
   FOR HireYear IN ([2010],[2011],[2012],[2013])<br />
) as PVT<&#47;pre><br />
The result of this query is shown in the following table. As you can see, the Pivot command can be quite handy in order to manipulate the structure of a table for various purposes, this might be useful some day.</p>
<div class="table-responsive">
<table class="table table-bordered table-post" style="table-layout: fixed;">
<thead>
<tr>
<th>HireYear<&#47;th></p>
<th>2010<&#47;th></p>
<th>2011<&#47;th></p>
<th>2012<&#47;th></p>
<th>2013<&#47;th><br />
<&#47;tr><br />
<&#47;thead></p>
<tbody>
<tr>
<td>AverageAge<&#47;td></p>
<td>29<&#47;td></p>
<td>37<&#47;td></p>
<td>33<&#47;td></p>
<td>27<&#47;td><br />
<&#47;tr><br />
<&#47;tbody><br />
<&#47;table><br />
<&#47;div></p>
